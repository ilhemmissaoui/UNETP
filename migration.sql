-- views for cotisation section
/* added total college student number  for subscription fees view ('vue_appli_cotis_etab')  */  
CREATE OR REPLACE VIEW vue_appli_cotis_etab AS select `u`.`id_unitorg` AS `id_unitorg`,`u`.`nom` AS `nom`,`u`.`archived` AS `archived`,`e`.`numero_etablissement` AS `numero_etablissement`,`e`.`id_etablissement`,`e`.`cle_etablissement` AS `cle_etablissement`,`param`.`annee` AS `annee`,`cot`.`id_cotisation` AS `id_cotisation`,`cot`.`statut` AS `statut`,`hc`.`id_historique_capacite` AS `id_historique_capacite`,ifnull(`hc`.`nb_eleves_sous_contrat_college`,0) AS `nb_sc_college`,ifnull(`hc`.`nb_eleves_sous_contrat_lp`,0) AS `nb_sc_lp`,ifnull(`hc`.`nb_eleves_sous_contrat_lt`,0) AS `nb_sc_lt`,ifnull(`hc`.`nb_eleves_sous_contrat_bts`,0) AS `nb_sc_bts`,ifnull(`hc`.`nb_eleves_sous_contrat_sup`,0) AS `nb_sc_sup`,(((ifnull(`hc`.`nb_eleves_sous_contrat_lp`,0) + ifnull(`hc`.`nb_eleves_sous_contrat_lt`,0)) + ifnull(`hc`.`nb_eleves_sous_contrat_bts`,0)) + ifnull(`hc`.`nb_eleves_sous_contrat_sup`,0)) AS `total_sc`,ifnull(`hc`.`nb_eleves_hors_contrat_lp`,0) AS `nb_hc_lp`,ifnull(`hc`.`nb_eleves_hors_contrat_lt`,0) AS `nb_hc_lt`,ifnull(`hc`.`nb_eleves_hors_contrat_bts`,0) AS `nb_hc_bts`,ifnull(`hc`.`nb_eleves_hors_contrat_sup`,0) AS `nb_hc_sup`,(((ifnull(`hc`.`nb_eleves_hors_contrat_lp`,0) + ifnull(`hc`.`nb_eleves_hors_contrat_lt`,0)) + ifnull(`hc`.`nb_eleves_hors_contrat_bts`,0)) + ifnull(`hc`.`nb_eleves_hors_contrat_sup`,0)) AS `total_hc`,ifnull(`hc`.`nb_apprentis_cfa_ufa`,0) AS `nb_apprentis`,ifnull(`hc`.`nb_heures_stagiaire_cfp_cfc`,0) AS `nb_heures`,ifnull(`hc`.`nb_eleves_college_employeur`,0) AS `nb_college_employeur`,ifnull(`cot`.`montant_part_fixe`,0) AS `montant_part_fixe`,`e`.`id_delegue` AS `id_delegue` from ((((`cotisation` `cot` join `unitorg` `u` on((`u`.`id_unitorg` = `cot`.`id_unitorg`))) join `etablissement` `e` on((`e`.`id_unitorg` = `u`.`id_unitorg`))) join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `cot`.`id_cotisation_parametre`))) left join `historique_capacite` `hc` on(((`hc`.`id_unitorg` = `u`.`id_unitorg`) and (`hc`.`annee` = `param`.`annee`))));
CREATE OR REPLACE VIEW vue_appli_bordereau AS select distinct `c`.`id_cotisation` AS `id_cotisation`,`e`.`cle_etablissement` AS `cle_etab`,`e`.`id_unitorg` AS `id_unitorg`,`param`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`param`.`annee` AS `annee`,`cref`.`date_depot` AS `date_depot`,`cref`.`id_cotisation_ref_paiement` AS `ref_paiement`,((((((((`param`.`sc_lp` * ifnull(`vue`.`nb_sc_lp`,0)) + (`param`.`sc_lt` * ifnull(`vue`.`nb_sc_lt`,0))) + (`param`.`sc_bts` * ifnull(`vue`.`nb_sc_bts`,0))) + (`param`.`sc_sup` * ifnull(`vue`.`nb_sc_sup`,0))) + (`param`.`hc_lp` * ifnull(`vue`.`nb_hc_lp`,0))) + (`param`.`hc_lt` * ifnull(`vue`.`nb_hc_lt`,0))) + (`param`.`hc_bts` * ifnull(`vue`.`nb_hc_bts`,0))) + (`param`.`hc_sup` * ifnull(`vue`.`nb_hc_sup`,0))) AS `calcule_sc_hc`,(ifnull(`vue`.`nb_apprentis`,0) * `param`.`cfa_ufa`) AS `calcule_apprentis`,round(((ifnull(`vue`.`nb_heures`,0) * `param`.`cfp_cfc`) / 1000),2) AS `calcule_cfc`,(ifnull(`vue`.`nb_college_employeur`,0) * `param`.`fonctionnement_college_employeur`) AS `calcule_college_employeur`,ifnull(`c`.`montant_part_fixe`,0) AS `montant_part_fixe`,`cp`.`montant` AS `montant_total` from (((((`cotisation` `c` join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `c`.`id_cotisation_parametre`))) join `cotisation_paiement` `cp` on((`cp`.`id_cotisation` = `c`.`id_cotisation`))) join `cotisation_ref_paiement` `cref` on((`cref`.`id_cotisation_ref_paiement` = `cp`.`id_cotisation_ref_paiement`))) join `etablissement` `e` on((`e`.`id_unitorg` = `c`.`id_unitorg`))) join `vue_appli_cotis_etab` `vue` on((`vue`.`id_unitorg` = `e`.`id_unitorg`))) where ((`cref`.`type_paiement` = 'Chèque') and (`param`.`annee` = `vue`.`annee`) and (`cp`.`montant` <> 0.00)) order by `cref`.`date_depot`;
CREATE OR REPLACE VIEW vue_appli_cotis_syndic AS select `cot_perso`.`id_personne` AS `id_personne`,`cot_perso`.`id_cotisation` AS `cot_perso`,`param`.`annee` AS `annee`,`lien_cot`.`id_cotisation_etablissement` AS `cot_etab`,ifnull(`syndic`.`libelle`,'UNETP') AS `syndicat`,`cot_perso`.`statut` AS `statut_perso` from (((`cotisation` `cot_perso` join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `cot_perso`.`id_cotisation_parametre`))) join `cotisation_has_cotisation` `lien_cot` on((`lien_cot`.`id_cotisation_personne` = `cot_perso`.`id_cotisation`))) left join `cotisation_syndicat` `syndic` on((`syndic`.`id_cotisation_syndicat` = `cot_perso`.`id_cotisation_syndicat`))) where (`cot_perso`.`id_personne` is not null) order by `cot_perso`.`id_personne`;
CREATE OR REPLACE VIEW vue_appli_cotis_etab_perso AS select `u`.`id_unitorg` AS `id_unitorg`,`u`.`nom` AS `nom`,`u`.`archived` AS `archived`,`u`.`numero_etablissement` AS `numero_etablissement`,`u`.`cle_etablissement` AS `cle_etablissement`,`u`.`annee` AS `annee`,`u`.`id_cotisation` AS `id_cotisation`,`u`.`statut` AS `statut_etab`,`u`.`id_historique_capacite` AS `id_historique_capacite`,`u`.`nb_sc_lp` AS `nb_sc_lp`,`u`.`nb_sc_lt` AS `nb_sc_lt`,`u`.`nb_sc_bts` AS `nb_sc_bts`,`u`.`nb_sc_sup` AS `nb_sc_sup`,`u`.`total_sc` AS `total_sc`,`u`.`nb_hc_lp` AS `nb_hc_lp`,`u`.`nb_hc_lt` AS `nb_hc_lt`,`u`.`nb_hc_bts` AS `nb_hc_bts`,`u`.`nb_hc_sup` AS `nb_hc_sup`,`u`.`total_hc` AS `total_hc`,`u`.`nb_apprentis` AS `nb_apprentis`,`u`.`nb_heures` AS `nb_heures`,`u`.`nb_college_employeur` AS `nb_college_employeur`,cast(concat(',',ifnull(group_concat(distinct `p`.`id_personne` separator ','),''),',') as char charset utf8mb3) AS `ids_personne`,cast(concat(',',ifnull(group_concat(distinct `p`.`cot_perso` separator ','),''),',') as char charset utf8mb3) AS `cot_persos`,group_concat(distinct `p`.`syndicat` separator ', ') AS `syndicats`,group_concat(distinct `p`.`statut_perso` separator ', ') AS `statuts_perso`,(case when ((`u`.`statut` = 'Solde initial') or (group_concat(distinct `p`.`statut_perso` separator ', ') like '%Solde initial%')) then 'Solde initial' when ((`u`.`statut` = 'Solde négatif') or (group_concat(distinct `p`.`statut_perso` separator ', ') like '%Solde négatif%')) then 'Solde négatif' when ((`u`.`statut` = 'Solde partiel') or (group_concat(distinct `p`.`statut_perso` separator ', ') like '%Solde partiel%')) then 'Solde partiel' when ((`u`.`statut` = 'Soldé') or (group_concat(distinct `p`.`statut_perso` separator ', ') like '%Soldé%')) then 'Soldé' when ((`u`.`statut` = 'Validé') or (group_concat(distinct `p`.`statut_perso` separator ', ') like '%Validé%')) then 'Validé' else 'Erreur' end) AS `statut_final` from (`vue_appli_cotis_etab` `u` left join `vue_appli_cotis_syndic` `p` on((`u`.`id_cotisation` = `p`.`cot_etab`))) group by `u`.`id_unitorg`,`u`.`annee`;
CREATE OR REPLACE VIEW vue_appli_paiement_annuel AS select `param`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`param`.`annee` AS `annee`,sum(ifnull(`c`.`montant_part_fixe`,0)) AS `montant_part_fixe`,sum(ifnull(`paie`.`montant`,0)) AS `paiements` from (((`cotisation_paiement` `paie` join `cotisation` `c` on((`c`.`id_cotisation` = `paie`.`id_cotisation`))) join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `c`.`id_cotisation_parametre`))) join `cotisation_ref_paiement` `r` on((`r`.`id_cotisation_ref_paiement` = `paie`.`id_cotisation_ref_paiement`))) where ((`c`.`id_unitorg` is not null) and (`c`.`statut` like 'valide') and ((`r`.`banque_statut` like 'ok') or (`r`.`banque_statut` is null))) group by `param`.`annee`;
CREATE OR REPLACE VIEW vue_temp_paiements_ce AS select `param`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`param`.`annee` AS `annee`,sum(ifnull(`paie`.`montant`,0)) AS `paiements` from (((`cotisation_paiement` `paie` join `cotisation` `c` on((`c`.`id_cotisation` = `paie`.`id_cotisation`))) join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `c`.`id_cotisation_parametre`))) join `cotisation_ref_paiement` `r` on((`r`.`id_cotisation_ref_paiement` = `paie`.`id_cotisation_ref_paiement`))) where ((`c`.`id_personne` is not null) and (`c`.`statut` like 'valide') and ((`r`.`banque_statut` like 'ok') or (`r`.`banque_statut` is null))) group by `param`.`annee`;
CREATE OR REPLACE VIEW vue_temp_paiements_etab AS select `param`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`param`.`annee` AS `annee`,sum(ifnull(`c`.`montant_part_fixe`,0)) AS `montant_part_fixe`,sum(ifnull(`paie`.`montant`,0)) AS `paiements` from (((`cotisation_paiement` `paie` join `cotisation` `c` on((`c`.`id_cotisation` = `paie`.`id_cotisation`))) join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `c`.`id_cotisation_parametre`))) join `cotisation_ref_paiement` `r` on((`r`.`id_cotisation_ref_paiement` = `paie`.`id_cotisation_ref_paiement`))) where ((`c`.`id_unitorg` is not null) and (`c`.`statut` like 'valide') and ((`r`.`banque_statut` like 'ok') or (`r`.`banque_statut` is null))) group by `param`.`annee`;
CREATE OR REPLACE VIEW vue_appli_paiement_annuel AS select `vue_etab`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`vue_etab`.`annee` AS `annee`,ifnull(`vue_ce`.`paiements`,0) AS `paiements_ces`,`vue_etab`.`paiements` AS `paiements_etabs`,`vue_etab`.`montant_part_fixe` AS `montant_part_fixe`,(ifnull(`vue_ce`.`paiements`,0) + `vue_etab`.`paiements`) AS `total` from (`vue_temp_paiements_etab` `vue_etab` left join `vue_temp_paiements_ce` `vue_ce` on((`vue_ce`.`id_cotisation_parametre` = `vue_etab`.`id_cotisation_parametre`)));
CREATE OR REPLACE VIEW vue_appli_personne AS select `vue_etab`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`vue_etab`.`annee` AS `annee`,ifnull(`vue_ce`.`paiements`,0) AS `paiements_ces`,`vue_etab`.`paiements` AS `paiements_etabs`,`vue_etab`.`montant_part_fixe` AS `montant_part_fixe`,(ifnull(`vue_ce`.`paiements`,0) + `vue_etab`.`paiements`) AS `total` from (`vue_temp_paiements_etab` `vue_etab` left join `vue_temp_paiements_ce` `vue_ce` on((`vue_ce`.`id_cotisation_parametre` = `vue_etab`.`id_cotisation_parametre`)));
CREATE OR REPLACE VIEW vue_appli_unitorg_etab AS select `u`.`id_unitorg` AS `id_unitorg`,`e`.`cle_etablissement` AS `cle_etablissement`,`e`.`numero_etablissement` AS `numero_etablissement`,`u`.`nom` AS `nom`,`a`.`nom` AS `academie`,concat(`d`.`code_departement`,_utf8mb3' - ',`d`.`libelle`) AS `departement`,`de`.`reference` AS `delegation`,`u`.`description` AS `description`,`e`.`relation_unetp` AS `relation_unetp`,`e`.`mixite` AS `mixite`,(select group_concat(distinct `le`.`libelle` separator ', ') from (`label_etablissement` `le` join `unitorg_has_label_etablissement` `ule`) where ((`ule`.`id_unitorg` = `u`.`id_unitorg`) and (`ule`.`id_label_etablissement` = `le`.`id_label_etablissement`))) AS `label_etablissement`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') from (`pays` `p` join `unitorg_has_pays_jumelage` `upj`) where ((`upj`.`id_etablisement_jumelage` = `u`.`id_unitorg`) and (`upj`.`id_pays_jumelage` = `p`.`id_pays`))) AS `jumelage`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') from (`pays` `p` join `unitorg_has_pays_partenaire` `upp`) where ((`upp`.`id_etablissement_partenaire` = `u`.`id_unitorg`) and (`upp`.`id_pays_partenaire` = `p`.`id_pays`))) AS `pays_partenaires`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') from (`pension` `p` join `unitorg_has_pension` `upp`) where ((`upp`.`id_etablissement` = `u`.`id_unitorg`) and (`upp`.`id_pension` = `p`.`id_pension`))) AS `pension`,(select group_concat(distinct `t`.`libelle` order by `t`.`libelle` ASC separator ', ') from (`tutelle` `t` join `unitorg_has_tutelle` `ut`) where ((`ut`.`id_etablissement` = `u`.`id_unitorg`) and (`ut`.`id_tutelle` = `t`.`id_tutelle`))) AS `tutelle`,`e`.`date_premiere_adhesion` AS `date_premiere_adhesion`,`c`.`libelle` AS `nom_coordonnee`,`c`.`destinataire` AS `adresse_destinataire`,`c`.`destinataire_complement` AS `adresse_complement_destinataire`,`c`.`adresse_ligne1` AS `adresse_ligne1`,concat_ws(_utf8mb3' ',`c`.`numero_voie`,`c`.`libelle_voie`) AS `adresse_ligne2`,`c`.`adresse_ligne3` AS `adresse_ligne3`,concat_ws(_utf8mb3' ',`c`.`code_postal`,`c`.`ville`,`c`.`cedex`) AS `adresse_ville`,`c`.`telephone` AS `telephone`,`c`.`fax` AS `fax`,`c`.`mobile` AS `mobile`,`c`.`email` AS `email`,`c`.`site_web` AS `site_web`,(select group_concat(concat(concat_ws(' ',`civ`.`abbreviation`,`p`.`prenom`,`p`.`nom`),' (',`lf`.`nom_masculin`,')') separator ', ') from (((`personne` `p` join `civilite` `civ`) join `fonction` `f`) join `label_fonction` `lf`) where ((`civ`.`id_civilite` = `p`.`id_civilite`) and (`p`.`id_personne` = `f`.`id_personne`) and (`f`.`id_unitorg` = `u`.`id_unitorg`) and (`f`.`id_label_fonction` = `lf`.`id_label_fonction`) and (`p`.`deleted` = 0) and (`p`.`archived` = 0) and (`lf`.`chef_etablissement` = 1) and (not((`lf`.`nom_masculin` like 'comptable'))))) AS `chef_etablissement`,`e`.`commentaires` AS `commentaires_publics`,`e`.`commentaires_formation` AS `commentaires_formation`,`e`.`commentaires_prives` AS `commentaires_prives`,`u`.`date_creation` AS `date_creation`,`u`.`date_modification` AS `date_derniere_modification`,`u`.`deleted` AS `deleted`,`u`.`archived` AS `archived` from (((((`unitorg` `u` left join `etablissement` `e` on((`e`.`id_unitorg` = `u`.`id_unitorg`))) left join `academie` `a` on((`a`.`id_academie` = `e`.`id_academie`))) left join `departement` `d` on((`d`.`id_departement` = `e`.`id_departement`))) left join `delegation` `de` on((`de`.`id_delegation` = `e`.`id_delegation`))) left join `coordonnee` `c` on((`c`.`id_unitorg` = `u`.`id_unitorg`))) where ((`u`.`id_type_unitorg` = 4) and ((`c`.`id_coordonnee` is null) or (`c`.`defaut` = 1))) order by `e`.`cle_etablissement`;
CREATE OR REPLACE VIEW vue_etab_unitorg AS select `u`.`id_unitorg` AS `id_unitorg`,`e`.`cle_etablissement` AS `Cle Etablissement`,`u`.`nom` AS `Nom`,`a`.`nom` AS `Académie`,concat(`d`.`code_departement`,_utf8mb3' - ',`d`.`libelle`) AS `Département`,`de`.`reference` AS `Délégation`,`u`.`description` AS `Description`,`e`.`relation_unetp` AS `Relation UNETP`,`e`.`mixite` AS `Mixite`,(select group_concat(distinct `le`.`libelle` separator ', ') AS `GROUP_CONCAT(DISTINCT le.libelle SEPARATOR ', ')` from (`label_etablissement` `le` join `unitorg_has_label_etablissement` `ule`) where ((`ule`.`id_unitorg` = `u`.`id_unitorg`) and (`ule`.`id_label_etablissement` = `le`.`id_label_etablissement`))) AS `Label d'établissement`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') AS `alias_jumelage` from (`pays` `p` join `unitorg_has_pays_jumelage` `upj`) where ((`upj`.`id_etablisement_jumelage` = `u`.`id_unitorg`) and (`upj`.`id_pays_jumelage` = `p`.`id_pays`))) AS `Jumelage`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') AS `alias_partenaire` from (`pays` `p` join `unitorg_has_pays_partenaire` `upp`) where ((`upp`.`id_etablissement_partenaire` = `u`.`id_unitorg`) and (`upp`.`id_pays_partenaire` = `p`.`id_pays`))) AS `Pays partenaires`,(select group_concat(distinct `p`.`libelle` order by `p`.`libelle` ASC separator ', ') AS `alias_pension` from (`pension` `p` join `unitorg_has_pension` `upp`) where ((`upp`.`id_etablissement` = `u`.`id_unitorg`) and (`upp`.`id_pension` = `p`.`id_pension`))) AS `Pension`,(select group_concat(distinct `t`.`libelle` order by `t`.`libelle` ASC separator ', ') AS `alias_tutelle` from (`tutelle` `t` join `unitorg_has_tutelle` `ut`) where ((`ut`.`id_etablissement` = `u`.`id_unitorg`) and (`ut`.`id_tutelle` = `t`.`id_tutelle`))) AS `Tutelle`,`e`.`date_premiere_adhesion` AS `Date de première adhésion`,`c`.`libelle` AS `Nom de la coordonnée`,`c`.`destinataire` AS `Adresse destinataire`,`c`.`destinataire_complement` AS `Adresse complément destinataire`,`c`.`adresse_ligne1` AS `Adresse Ligne 1`,concat_ws(_utf8mb3' ',`c`.`numero_voie`,`c`.`libelle_voie`) AS `Adresse Ligne 2`,`c`.`adresse_ligne3` AS `Adresse Ligne 3`,concat_ws(_utf8mb3' ',`c`.`code_postal`,`c`.`ville`,`c`.`cedex`) AS `Adresse ville`,`c`.`telephone` AS `Téléphone`,`c`.`fax` AS `Fax`,`c`.`mobile` AS `Mobile`,`c`.`email` AS `Email`,`c`.`site_web` AS `Site Web`,(select group_concat(concat(concat_ws(_utf8mb3' ',`civ`.`abbreviation`,`p`.`prenom`,`p`.`nom`),_utf8mb3' (',`lf`.`nom_masculin`,_utf8mb3')') separator ', ') AS `alias_chef` from (((`personne` `p` join `civilite` `civ` on((`civ`.`id_civilite` = `p`.`id_civilite`))) join `fonction` `f` on((`p`.`id_personne` = `f`.`id_personne`))) join `label_fonction` `lf` on((`lf`.`id_label_fonction` = `f`.`id_label_fonction`))) where ((`f`.`id_unitorg` = `u`.`id_unitorg`) and (`p`.`deleted` = 0) and (`p`.`archived` = 0) and (`lf`.`chef_etablissement` = 1) and (not((`lf`.`nom_masculin` like 'comptable'))))) AS `Chef d'établissement`,`e`.`commentaires` AS `Commentaires publics`,`e`.`commentaires_formation` AS `Commentaires formation`,`e`.`commentaires_prives` AS `Commentaires privés`,date_format(`u`.`date_creation`,_utf8mb3'%d/%m/%Y') AS `Date de création`,date_format(`u`.`date_modification`,_utf8mb3'%d/%m/%Y') AS `Date de dernière modification` from (((((`unitorg` `u` left join `etablissement` `e` on((`e`.`id_unitorg` = `u`.`id_unitorg`))) left join `academie` `a` on((`a`.`id_academie` = `e`.`id_academie`))) left join `departement` `d` on((`d`.`id_departement` = `e`.`id_departement`))) left join `delegation` `de` on((`de`.`id_delegation` = `e`.`id_delegation`))) left join `coordonnee` `c` on((`c`.`id_unitorg` = `u`.`id_unitorg`))) where ((`u`.`id_type_unitorg` = 4) and (`u`.`deleted` = 0) and (`u`.`archived` = 0) and (`c`.`defaut` = 1)) order by `e`.`cle_etablissement`;
CREATE OR REPLACE VIEW vue_temp_bordereau_etab AS select distinct `c`.`id_cotisation` AS `id_cotisation`,`e`.`cle_etablissement` AS `cle_etab`,`e`.`id_unitorg` AS `id_unitorg`,`param`.`id_cotisation_parametre` AS `id_cotisation_parametre`,`param`.`annee` AS `annee`,`cref`.`date_depot` AS `date_depot`,`cref`.`id_cotisation_ref_paiement` AS `ref_paiement`,((((((((`param`.`sc_lp` * ifnull(`vue`.`nb_sc_lp`,0)) + (`param`.`sc_lt` * ifnull(`vue`.`nb_sc_lt`,0))) + (`param`.`sc_bts` * ifnull(`vue`.`nb_sc_bts`,0))) + (`param`.`sc_sup` * ifnull(`vue`.`nb_sc_sup`,0))) + (`param`.`hc_lp` * ifnull(`vue`.`nb_hc_lp`,0))) + (`param`.`hc_lt` * ifnull(`vue`.`nb_hc_lt`,0))) + (`param`.`hc_bts` * ifnull(`vue`.`nb_hc_bts`,0))) + (`param`.`hc_sup` * ifnull(`vue`.`nb_hc_sup`,0))) AS `calcule_sc_hc`,(ifnull(`vue`.`nb_apprentis`,0) * `param`.`cfa_ufa`) AS `calcule_apprentis`,round(((ifnull(`vue`.`nb_heures`,0) * `param`.`cfp_cfc`) / 1000),2) AS `calcule_cfc`,(ifnull(`vue`.`nb_college_employeur`,0) * `param`.`fonctionnement_college_employeur`) AS `calcule_college_employeur`,ifnull(`c`.`montant_part_fixe`,0) AS `montant_part_fixe`,`cp`.`montant` AS `montant_total` from (((((`cotisation` `c` join `cotisation_parametre` `param` on((`param`.`id_cotisation_parametre` = `c`.`id_cotisation_parametre`))) join `cotisation_paiement` `cp` on((`cp`.`id_cotisation` = `c`.`id_cotisation`))) join `cotisation_ref_paiement` `cref` on((`cref`.`id_cotisation_ref_paiement` = `cp`.`id_cotisation_ref_paiement`))) join `etablissement` `e` on((`e`.`id_unitorg` = `c`.`id_unitorg`))) join `vue_appli_cotis_etab` `vue` on((`vue`.`id_unitorg` = `e`.`id_unitorg`))) where ((`cref`.`type_paiement` = 'Chèque') and (`param`.`annee` = `vue`.`annee`) and (`cp`.`montant` <> 0.00)) order by `cref`.`date_depot`;
CREATE OR REPLACE VIEW vue_temp_bordereau_pers AS select `p`.`id_personne` AS `id_personne`,`c`.`id_cotisation` AS `id_cotisation`,`cref`.`date_depot` AS `date_depot`,`cref`.`id_cotisation_ref_paiement` AS `ref_paiement`,ifnull(`cp`.`montant`,0) AS `montant_total`,`c`.`id_unitorg` AS `id_unitorg` from (((((`personne` `p` join `cotisation` `c` on((`c`.`id_personne` = `p`.`id_personne`))) join `cotisation_paiement` `cp` on((`cp`.`id_cotisation` = `c`.`id_cotisation`))) join `cotisation_ref_paiement` `cref` on((`cref`.`id_cotisation_ref_paiement` = `cp`.`id_cotisation_ref_paiement`))) join `fonction` `f` on((`f`.`id_personne` = `p`.`id_personne`))) join `label_fonction` `label` on((`label`.`id_label_fonction` = `f`.`id_label_fonction`))) where ((`cref`.`type_paiement` = 'Chèque') and (`label`.`chef_etablissement` = 1)) order by `cref`.`date_depot`;
CREATE OR REPLACE VIEW vue_temp_cotis_annuelle_chef AS select `param`.`annee` AS `annee`,count(`p`.`id_personne`) AS `nb_chef`,sum(ifnull(`c`.`montant_calcule`,0)) AS `tot_montant_calcule`,sum(ifnull(`c`.`montant_personnalise`,0)) AS `tot_montant_personnalise`,sum(ifnull(`c`.`montant_personnalise`,ifnull(`c`.`montant_calcule`,0))) AS `montant_total` from ((`personne` `p` join `cotisation` `c`) join `cotisation_parametre` `param`) where ((`p`.`id_personne` = `c`.`id_personne`) and (`c`.`id_cotisation_parametre` = `param`.`id_cotisation_parametre`) and (`c`.`id_cotisation_syndicat` is null)) group by `param`.`annee`;
CREATE OR REPLACE VIEW vue_temp_cotis_annuelle_etudiant AS select `vue`.`annee` AS `annee`,sum(ifnull(`vue`.`total_sc`,0)) AS `somme_LTP`,(((sum((`param`.`sc_lp` * ifnull(`vue`.`nb_sc_lp`,0))) + sum((`param`.`sc_lt` * ifnull(`vue`.`nb_sc_lt`,0)))) + sum((`param`.`sc_bts` * ifnull(`vue`.`nb_sc_bts`,0)))) + sum((`param`.`sc_sup` * ifnull(`vue`.`nb_sc_sup`,0)))) AS `caLTP`,sum(ifnull(`vue`.`total_hc`,0)) AS `somme_HC`,(((sum((`param`.`hc_lp` * ifnull(`vue`.`nb_hc_lp`,0))) + sum((`param`.`hc_lt` * ifnull(`vue`.`nb_hc_lt`,0)))) + sum((`param`.`hc_bts` * ifnull(`vue`.`nb_hc_bts`,0)))) + sum((`param`.`hc_sup` * ifnull(`vue`.`nb_hc_sup`,0)))) AS `caHC`,sum(ifnull(`vue`.`nb_apprentis`,0)) AS `somme_apprentis`,(sum(ifnull(`vue`.`nb_apprentis`,0)) * `param`.`cfa_ufa`) AS `ca_apprentis`,sum(ifnull(`vue`.`nb_heures`,0)) AS `nb_heures_stagiaires`,round(((sum(ifnull(`vue`.`nb_heures`,0)) * `param`.`cfp_cfc`) / 1000),2) AS `ca_cfc`,sum(ifnull(`vue`.`nb_college_employeur`,0)) AS `somme_college_employeur`,(sum(ifnull(`vue`.`nb_college_employeur`,0)) * `param`.`fonctionnement_college_employeur`) AS `ca_college_employeur`,sum(ifnull(`vue`.`montant_part_fixe`,0)) AS `montant_part_fixe` from ((`vue_appli_cotis_etab` `vue` join `cotisation_parametre` `param`) join `cotisation` `c`) where ((`c`.`id_cotisation_parametre` = `param`.`id_cotisation_parametre`) and (`c`.`id_cotisation` = `vue`.`id_cotisation`) and (`vue`.`archived` <> 1)) group by `vue`.`annee`;
SET GLOBAL sql_mode=(SELECT REPLACE(@@sql_mode,'ONLY_FULL_GROUP_BY',''));

-- migration for ogec  adding 5 column in establishment
ALTER TABLE `etablissement`
    ADD `name` varchar(255) DEFAULT NULL,
    ADD `phone_number` varchar(255) DEFAULT NULL,
    ADD `zip_code` varchar(255) DEFAULT NULL,
	ADD `city` varchar(255) DEFAULT NULL,
	ADD `email` varchar(255) DEFAULT NULL;
-- migration for advanced request creation
ALTER TABLE `ra_requete` 
	ADD COLUMN `tree` TEXT DEFAULT NULL,
	ADD COLUMN `fields` TEXT DEFAULT NULL;
-- migration for request table
ALTER TABLE `demande`
     RENAME COLUMN `xml` TO `json`,
     RENAME COLUMN `auteur` TO `user_id`;
ALTER TABLE `demande`	 
	 MODIFY COLUMN `user_id` INTEGER,
	 ADD CONSTRAINT FK_Demande_Person FOREIGN KEY (`user_id`) REFERENCES personne (id_personne) ON DELETE CASCADE;
-- Delete all Hisotrique with label e-mailing
DELETE 
FROM
	historique 
WHERE
	historique.id_type_historique = (
SELECT
		th.id_type_historique 
	FROM
		type_historique th 
	WHERE
	th.libelle = 'e-mailing' 
	);
-- Delete history-type e-mailing
DELETE 
FROM type_historique
WHERE type_historique.libelle='e-mailing' ;

-- Add full text search: etablissement
ALTER TABLE `unetp`.`etablissement` 
ADD FULLTEXT INDEX `_search`(`cle_etablissement`, `numero_etablissement`) VISIBLE;

-- Add full text search: orgnization
ALTER TABLE `unetp`.`unitorg` 
ADD FULLTEXT INDEX `_search`(`nom`) VISIBLE;

-- Add full text search: personne
ALTER TABLE `unetp`.`personne` 
ADD FULLTEXT INDEX `_search`(`nom`, `prenom`) VISIBLE;

-- Add full text search: delegation
ALTER TABLE `unetp`.`delegation` 
ADD FULLTEXT INDEX `_search`(`reference`) VISIBLE;

-- Add Table Historique Relance 
CREATE TABLE `historque_relance` (
	`id_historique_relance` INT NOT NULL AUTO_INCREMENT,
	`id_etablissement` INT NOT NULL,
	`sujet`varchar(255) NOT NULL,
	`contenu` TEXT DEFAULT NULL,
	`date_envoie` datetime,
	`statut` tinyint ,
	PRIMARY KEY ( `id_historique_relance` ),
FOREIGN KEY ( `id_etablissement` ) REFERENCES `etablissement` ( `id_etablissement` ));

-- truncate Table ra_request

TRUNCATE TABLE ra_requete ;


-- create Historique réadhésion & démission
CREATE TABLE `historique_readh_dem` (
	`id_historique_readh_dem` INT NOT NULL AUTO_INCREMENT,
	`id_etablissement` INT NOT NULL,
	`type_historique` ENUM('readhesion','demission'),
	`date` date,
	PRIMARY KEY (`id_historique_readh_dem`),
FOREIGN KEY ( `id_etablissement` ) REFERENCES `etablissement` ( `id_etablissement` ));
